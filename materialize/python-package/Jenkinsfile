node ('git') {
    stage ('checkout') {
        checkout scm
    }

    stage ('build') {
        // Report status of stage 'build' back to Gitlab
        gitlabCommitStatus(name: 'build') {
            def buildDir = 'materialize/python-package/pkg-build'

            // Clean the build directory before starting
            sh "rm -rf ${buildDir}"
            sh "mkdir -p ${buildDir}"

            dir ('materialize/python-package/debian') {
                sh './make-changelog'
            }

            sh './materialize/python-package/package'

            publishPackages buildDir.toString(), 'common/stable', 'xenial'

            archiveArtifacts(artifacts: "${buildDir}/*")
        }
    }
}
